<!DOCTYPE html>
<html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="../css/slides.css">
    <link rel="stylesheet" href="../css/myriad.css">
    <link rel="stylesheet" href="../css/highlight.css">
    <title>M2101 - Architecture et programmation bas niveau</title>
</head>
<body>


<a id="slide_anchor0"></a><section class="title">
    <h1>Cours n° 2 :<br>Appels systèmes<br>et entrée / sortie</h1>
    <div class="context">M2101 - Architecture et programmation bas niveau</div>
    <div class="author">Victor Poupet</div>
    <time datetime="2018-02-12">12 février 2018</time>
<div class="slide_footer"><div class="page_counter">0 / 14</div></div><a href="#slide_anchor-1" class="prev_flat_link"></a><a href="#slide_anchor1" class="next_flat_link"></a></section>


<a id="slide_anchor1"></a><section class="single">
    <h1>Système d'exploitation</h1>
    <div>
        <ul>
            <li>Le système d'exploitation (OS) est le premier programme exécuté au démarrage de l'ordinateur
            </li><li>C'est l'OS qui gère toute l'activité de l'ordinateur (mémoire, utilisateurs, processeur, périphériques,
            réseau, etc.)
            </li><li>En cours&nbsp;: <em>Unix</em> (mais les autres sont similaires)
            </li><li>Les programmes communiquent avec l'OS par l'intérmédiaire d'appels systèmes (<em>system call</em>)
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">1 / 14</div></div><a href="#slide_anchor0" class="prev_flat_link"></a><a href="#slide_anchor2" class="next_flat_link"></a></section>


<a id="slide_anchor2"></a><section class="single">
    <h1>Appels systèmes</h1>
    <div>
        Les appels systèmes ressemblent à des procédures (appels de fonction), avec toutefois des différences
        importantes&nbsp;:
        <ul>
            <li>Les appels systèmes sont très coûteux en ressources&nbsp;:
                <ul>
                    <li>le système sauvegarde l'état
                    </li><li>l'OS prend le contrôle du CPU
                    </li><li>l'OS exécute une tâche spécifique
                    </li><li>l'OS sauvegarde son état
                    </li><li>le contrôle est rendu au processus qui a lancé l'appel
                </li></ul>
            </li><li>Les appels systèmes dépendent du système d'exploitation
            </li><li>Il ne faut pas les utiliser directement si le programme doit être portable
            </li><li>La réalisation détaillée d'un appel système demande une connaissance précise des registres du processeur
            </li><li>Il faut être très prudent pour ne pas provoquer d'erreurs
            </li><li>On utilise en général une fonction qui se charge de faire l'appel
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">2 / 14</div></div><a href="#slide_anchor1" class="prev_flat_link"></a><a href="#slide_anchor3" class="next_flat_link"></a></section>


<a id="slide_anchor3"></a><section class="split">
    <h1>Entrée / Sortie</h1>
    <div class="leftside">
        <pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> flags[, <span class="hljs-keyword">int</span> mode])</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> size)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> size)</span></span>;
<span class="hljs-keyword">off_t</span> <span class="highlight">lseek</span>(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> offset, <span class="hljs-keyword">int</span> whence);
</code></pre>
    </div>

    <div class="rightside">
        Il existe 5 appels systèmes principaux pour manipuler des fichiers.
        <ul>
            <li>ressemblent à des procédures, mais sont envoyés directement au système
                souvent on utilise des fonctions qui font un appel système (ex : <code>fopen</code> qui appelle
                <code>open</code>)
            </li><li>les entrées/sorties sont gérées par l'OS pour éviter que des erreurs dans les programmes aient des
            conséquences sur le système de fichiers
            </li><li>chaque appel est décrit dans sa page de manuel (ex : <code>man 2 open</code>)
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">3 / 14</div></div><a href="#slide_anchor2" class="prev_flat_link"></a><a href="#slide_anchor4" class="next_flat_link"></a></section>


<a id="slide_anchor4"></a><section class="single">
    <h1>man 2 open</h1>
    <div>
        <pre><code class="plaintext hljs">
    OPEN(2)                 BSD System Calls Manual                OPEN(2)

    NAME
         <span class="highlight">open</span> -- open or create a file for reading or writing

    SYNOPSIS
         <span class="highlight">#include &lt;fcntl.h&gt;</span>

         <span class="highlight">int open(const char *path, int oflag, ...);</span>

    DESCRIPTION
         The file name specified by path is opened for reading and/or writing, as specified by the argument oflag; the file descriptor is returned to the calling process.

         The oflag argument may indicate that the file is to be created if it does not exist (by specifying the O_CREAT flag).  In this case, open requires a third argument mode_t mode; the file is created with mode mode as described in chmod(2) and modified by the process' umask value (see umask(2)).
        </code></pre>
    </div>
<div class="slide_footer"><div class="page_counter">4 / 14</div></div><a href="#slide_anchor3" class="prev_flat_link"></a><a href="#slide_anchor5" class="next_flat_link"></a></section>


<a id="slide_anchor5"></a><section class="split">
    <h1>Open</h1>
    <div class="leftside">
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> flags[, <span class="hljs-keyword">int</span> mode])</span></span>;</code></pre>
        <hr>
        <pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>

main()
{
  <span class="hljs-keyword">int</span> fd;

  fd = <span class="highlight">open</span>(<span class="hljs-string">"test.txt"</span>, O_RDONLY);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, fd);
}</code></pre>
    </div>
    <div class="rightside">
        L'appel <code>open</code> sert à demander l'accès à un fichier
        <ul>
            <li><code>path</code> indique le chemin du fichier
            </li><li><code>flags</code> indique comment on veut manipuler le fichier
            </li><li><code>mode</code> définit les permissions à donner en cas de création d'un nouveau fichier
            </li><li>le résultat est un entier correspondant à un descripteur de fichier (ou -1 en cas d'erreur)
            </li><li>Tous les autres appels E/S utilisent un descripteur de fichier
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">5 / 14</div></div><a href="#slide_anchor4" class="prev_flat_link"></a><a href="#slide_anchor6" class="next_flat_link"></a></section>


<a id="slide_anchor6"></a><section class="split">
    <h1>Open (flags)</h1>
    <div class="leftside">
        <pre><code class="hljs"><span class="highlight">O_RDONLY</span> open for reading only
<span class="highlight">O_WRONLY</span> open for writing only
<span class="highlight">O_RDWR</span> open for reading and writing
O_NONBLOCK do not block on open or for data to become available
<span class="highlight">O_APPEND</span> append on each write
<span class="highlight">O_CREAT</span> create file if it does not exist
<span class="highlight">O_TRUNC</span> truncate size to 0
O_EXCL error if O_CREAT and the file exists
O_SHLOCK atomically obtain a shared lock
O_EXLOCK atomically obtain an exclusive lock
O_NOFOLLOW do not follow symlinks
O_SYMLINK allow open of symlinks
O_EVTONLY descriptor requested for event notifications only
O_CLOEXEC mark as close-on-exec</code></pre>
    </div>
    <div class="rightside">
        <ul>
            <li>L'argument <code>flags</code> est un ou bit-à-bit de valeurs
            </li><li>Les valeurs possibles sont définies dans <code>/usr/include/sys/fcntl.h</code>
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">6 / 14</div></div><a href="#slide_anchor5" class="prev_flat_link"></a><a href="#slide_anchor7" class="next_flat_link"></a></section>


<a id="slide_anchor7"></a><section class="split">
    <h1>Close</h1>
    <div class="leftside">
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;</code></pre>
        <hr>
        <pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
main() {
  <span class="hljs-keyword">int</span> fd1, fd2;

  fd1 = <span class="highlight">open</span>(<span class="hljs-string">"test.txt"</span>, O_RDONLY);
  <span class="hljs-keyword">if</span> (fd1 &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }
  fd2 = <span class="highlight">open</span>(<span class="hljs-string">"test.txt"</span>, O_RDONLY);
  <span class="hljs-keyword">if</span> (fd2 &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">if</span> (<span class="highlight">close</span>(fd1) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }
}</code></pre>
    </div>
    <div class="rightside">
        L'appel <code>close</code> permet de libérer un descripteur de fichier
        <ul>
            <li>Le résultat est 0 en cas de réussite, -1 en cas d'erreur
            </li><li>Les descripteurs de fichier sont tous libérés à la fin d'un processus
            </li><li>Le nombre de fichiers ouverts par un processus est limité (dépend du système, varie d'une centaine à plusieurs milliers)
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">7 / 14</div></div><a href="#slide_anchor6" class="prev_flat_link"></a><a href="#slide_anchor8" class="next_flat_link"></a></section>


<a id="slide_anchor8"></a><section class="split">
    <h1>Read</h1>
    <div class="leftside">
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> size)</span></span>;</code></pre>
        <hr>
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">char</span> *b;
  <span class="hljs-keyword">int</span> fd, sz;
  b = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * <span class="hljs-number">11</span>);

  fd = <span class="highlight">open</span>(<span class="hljs-string">"test.txt"</span>, O_RDONLY);
  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">do</span> {
    sz = <span class="highlight">read</span>(fd, b, <span class="hljs-number">10</span>);
    b[sz] = <span class="hljs-string">'\0'</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"lu: %s\n"</span>, b);
  } <span class="hljs-keyword">while</span> (sz == <span class="hljs-number">10</span>);

  <span class="highlight">close</span>(fd);
}</code></pre>
    </div>
    <div class="rightside">
        L'appel <code>read</code> sert à lire des octets dans un fichier
        <ul>
            <li><code>fd</code> est le descripteur du fichier à lire
            </li><li><code>buf</code> est un pointeur vers un tableau où mettre les caractères lus
            </li><li><code>size</code> est le nombre d'octets à lire
            </li><li>le résultat est le nombre d'octets effectivement lus (peut être inférieur à <code>size</code> si on est en fin de fichier)
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">8 / 14</div></div><a href="#slide_anchor7" class="prev_flat_link"></a><a href="#slide_anchor9" class="next_flat_link"></a></section>


<a id="slide_anchor9"></a><section class="split">
    <h1>Write</h1>
    <div class="leftside">
    <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> </span><span class="highlight"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> size)</span></span>;</code></pre>
        <hr>
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> fd, sz;
  <span class="hljs-keyword">char</span> *txt;

  fd = <span class="highlight">open</span>(<span class="hljs-string">"test.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number">0644</span>);
  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  txt = <span class="hljs-string">"Bonjour\n"</span>;
  sz = <span class="highlight">write</span>(fd, txt, <span class="hljs-number">8</span>);

  <span class="highlight">close</span>(fd);
}</code></pre>
    </div>
    <div class="rightside">
        L'appel <code>write</code> permet d'écrire des octets dans un fichier
        <ul>
            <li><code>fd</code> est le descripteur du fichier où écrire
            </li><li><code>buf</code> est un pointeur vers un tableau de caractères à écrire
            </li><li><code>size</code> correspond au nombre de caractères du tableau <code>buf</code> à écrire
            </li><li>le résultat est le nombre d'octets effectivement écrits (devrait toujours être égal à <code>size</code>)
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">9 / 14</div></div><a href="#slide_anchor8" class="prev_flat_link"></a><a href="#slide_anchor10" class="next_flat_link"></a></section>


<a id="slide_anchor10"></a><section class="split">
    <h1>Pointeur de fichier</h1>
    <div class="leftside">
        <pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">char</span> *c;
  <span class="hljs-keyword">int</span> fd, sz;
  c = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * <span class="hljs-number">10</span>);

  fd = open(<span class="hljs-string">"test.txt"</span>, O_RDWR | O_APPEND);
  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
    sz = read(fd, c, <span class="hljs-number">10</span>);
    write(fd, c, sz);
    <span class="hljs-keyword">if</span> (sz &lt; <span class="hljs-number">10</span>) <span class="hljs-keyword">break</span>;
  }

  close(fd);
}
        </code></pre>
    </div>
    <div class="rightside">
        Les fichiers ouverts sont tous associés à un <em>pointeur de fichier</em> qui indique un emplacement dans le fichier
        <ul>
            <li>Initialement, le pointeur est au début du fichier
            </li><li>Lorsque l'on utilise <code>read</code> ou <code>write</code>, la lecture et l'écriture se font au niveau du pointeur
            </li><li>Le pointeur est automatiquement avancé par la lecture et l'écriture
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">10 / 14</div></div><a href="#slide_anchor9" class="prev_flat_link"></a><a href="#slide_anchor11" class="next_flat_link"></a></section>


<a id="slide_anchor11"></a><section class="split">
    <h1>Ouvertures multiples</h1>
    <div class="leftside">
        <pre><code class="cpp only hljs" data-end="1">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> fd1, fd2;

  fd1 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC);
  fd2 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY);

  write(fd1, <span class="hljs-string">"un "</span>, <span class="hljs-number">3</span>);
  write(fd2, <span class="hljs-string">"deux "</span>, <span class="hljs-number">5</span>);
  write(fd1, <span class="hljs-string">"trois "</span>, <span class="hljs-number">6</span>);
}

<span class="uncover hidden" data-start="1">⟶ deutrois</span>
        </code></pre>
    </div>
    <div class="rightside">
        On peut ouvrir plusieurs fois un même fichier (même en écriture)
        <ul>
            <li>chaque descripteur a son propre pointeur de fichier
            </li><li>les ouvertures en mode <code>O_APPEND</code> restent à la fin du fichier
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">11 / 14</div></div><a href="#slide_anchor10" class="prev_flat_link"></a><a href="#slide_anchor12" class="next_flat_link"></a></section><a id="slide_anchor12"></a><section class="split">
    <h1>Ouvertures multiples</h1>
    <div class="leftside">
        <pre><code class="cpp only hljs" data-end="1">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> fd1, fd2;

  fd1 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC);
  fd2 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY);

  write(fd1, <span class="hljs-string">"un "</span>, <span class="hljs-number">3</span>);
  write(fd2, <span class="hljs-string">"deux "</span>, <span class="hljs-number">5</span>);
  write(fd1, <span class="hljs-string">"trois "</span>, <span class="hljs-number">6</span>);
}

<span class="uncover" data-start="1">⟶ deutrois</span>
        </code></pre>
    </div>
    <div class="rightside">
        On peut ouvrir plusieurs fois un même fichier (même en écriture)
        <ul>
            <li>chaque descripteur a son propre pointeur de fichier
            </li><li>les ouvertures en mode <code>O_APPEND</code> restent à la fin du fichier
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">11 / 14</div></div><a href="#slide_anchor11" class="prev_flat_link"></a><a href="#slide_anchor13" class="next_flat_link"></a></section><a id="slide_anchor13"></a><section class="split">
    <h1>Ouvertures multiples</h1>
    <div class="leftside">
        <pre><code class="cpp only hljs" data-start="2">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> fd1, fd2;

  fd1 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC | <span class="highlight">O_APPEND</span>);
  fd2 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | <span class="highlight">O_APPEND</span>);

  write(fd1, <span class="hljs-string">"un "</span>, <span class="hljs-number">3</span>);
  write(fd2, <span class="hljs-string">"deux "</span>, <span class="hljs-number">5</span>);
  write(fd1, <span class="hljs-string">"trois "</span>, <span class="hljs-number">6</span>);
}

<span class="uncover hidden" data-start="3">⟶ un deux trois</span>
        </code></pre>
    </div>
    <div class="rightside">
        On peut ouvrir plusieurs fois un même fichier (même en écriture)
        <ul>
            <li>chaque descripteur a son propre pointeur de fichier
            </li><li>les ouvertures en mode <code>O_APPEND</code> restent à la fin du fichier
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">11 / 14</div></div><a href="#slide_anchor12" class="prev_flat_link"></a><a href="#slide_anchor14" class="next_flat_link"></a></section><a id="slide_anchor14"></a><section class="split">
    <h1>Ouvertures multiples</h1>
    <div class="leftside">
        <pre><code class="cpp only hljs" data-start="2">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> fd1, fd2;

  fd1 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC | <span class="highlight">O_APPEND</span>);
  fd2 = open(<span class="hljs-string">"test.txt"</span>, O_WRONLY | <span class="highlight">O_APPEND</span>);

  write(fd1, <span class="hljs-string">"un "</span>, <span class="hljs-number">3</span>);
  write(fd2, <span class="hljs-string">"deux "</span>, <span class="hljs-number">5</span>);
  write(fd1, <span class="hljs-string">"trois "</span>, <span class="hljs-number">6</span>);
}

<span class="uncover" data-start="3">⟶ un deux trois</span>
        </code></pre>
    </div>
    <div class="rightside">
        On peut ouvrir plusieurs fois un même fichier (même en écriture)
        <ul>
            <li>chaque descripteur a son propre pointeur de fichier
            </li><li>les ouvertures en mode <code>O_APPEND</code> restent à la fin du fichier
        </li></ul>
    </div>
<div class="slide_footer"><div class="page_counter">11 / 14</div></div><a href="#slide_anchor13" class="prev_flat_link"></a><a href="#slide_anchor15" class="next_flat_link"></a></section>


<a id="slide_anchor15"></a><section class="split">
    <h1>stdin, stdout, stderr</h1>
    <div class="leftside">
        <pre><code class="cpp hljs">
main() {
  <span class="hljs-keyword">char</span> c;
  <span class="hljs-keyword">while</span> (read(<span class="hljs-number">0</span>, &amp;c, <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) {
    write(<span class="hljs-number">1</span>, &amp;c, <span class="hljs-number">1</span>);
  }
}
        </code></pre>
    </div>
    <div class="rightside">
        Les trois premiers descripteurs de fichiers sont automatiquement attribués à chaque processus&nbsp;:
        <ul>
            <li>0&nbsp;: entrée standard (<code>stdin</code>)
            </li><li>1&nbsp;: sortie standard (<code>stdout</code>)
            </li><li>2&nbsp;: sortie d'erreur (<code>stderr</code>)
        </li></ul>
        On peut directement utiliser ces descripteurs de fichiers sans avoir à utiliser <code>open</code>.
    </div>
<div class="slide_footer"><div class="page_counter">12 / 14</div></div><a href="#slide_anchor14" class="prev_flat_link"></a><a href="#slide_anchor16" class="next_flat_link"></a></section>


<a id="slide_anchor16"></a><section class="split">
    <h1>lseek</h1>
    <div class="leftside">
        <pre><code class="cpp hljs"><span class="hljs-keyword">off_t</span> <span class="highlight">lseek</span>(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> offset, <span class="hljs-keyword">int</span> whence);</code></pre>
        <hr>
        <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">char</span> c[<span class="hljs-number">10</span>];
  <span class="hljs-keyword">int</span> fd, sz;
  fd = open(<span class="hljs-string">"test.txt"</span>, O_RDWR);
  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">int</span> rp = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">int</span> wp = <span class="highlight">lseek</span>(fd, <span class="hljs-number">0</span>, SEEK_END);
  <span class="hljs-keyword">do</span> {
    <span class="highlight">lseek</span>(fd, rp, SEEK_SET);
    sz = read(fd, c, <span class="hljs-number">10</span>);
    rp = <span class="highlight">lseek</span>(fd, <span class="hljs-number">0</span>, SEEK_CUR);

    <span class="highlight">lseek</span>(fd, wp, SEEK_SET);
    write(fd, c, sz);
    wp = <span class="highlight">lseek</span>(fd, <span class="hljs-number">0</span>, SEEK_CUR);
  } <span class="hljs-keyword">while</span> (sz == <span class="hljs-number">10</span>);
  close(fd);
}</code></pre>
    </div>
    <div class="rightside">
        <code>lseek</code> permet de déplacer manuellement le pointeur de fichier
        <ul>
            <li><code>fd</code> désigne le descripteur de fichier
            </li><li><code>offset</code> indique le nombre d'octets de déplacement
            </li><li><code>whence</code> permet de décrire la référence du déplacement
                <ul>
                    <li><code>SEEK_SET</code> début du fichier
                    </li><li><code>SEEK_CUR</code> position actuelle
                    </li><li><code>SEEK_END</code> fin du fichier
                </li></ul>
            </li><li>Le résultat est la position absolue du curseur après déplacement
        </li></ul>
        Il est possible de déplacer le curseur au-delà de la fin du fichier
    </div>
<div class="slide_footer"><div class="page_counter">13 / 14</div></div><a href="#slide_anchor15" class="prev_flat_link"></a><a href="#slide_anchor17" class="next_flat_link"></a></section>


<a id="slide_anchor17"></a><section class="split">
    <h1>stdio.h</h1>
    <div class="leftside">
        <pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="highlight">FILE *fpin, *fpout;</span>
  <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;

  fpin = <span class="highlight">fopen</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"r"</span>);
  fpout = <span class="highlight">fopen</span>(<span class="hljs-string">"res.txt"</span>, <span class="hljs-string">"w"</span>);
  <span class="hljs-keyword">char</span> s[<span class="hljs-number">80</span>];

  <span class="hljs-keyword">while</span>(<span class="highlight">fgets</span>(s, <span class="hljs-number">80</span>, fpin)) {
    <span class="highlight"><span class="hljs-built_in">fprintf</span></span>(fpout, <span class="hljs-string">"ligne %d: %s"</span>, i, s);
    i++;
  }

  <span class="highlight">fclose</span>(fpin);
  <span class="highlight">fclose</span>(fpout);
}
        </code></pre>
    </div>
    <div class="rightside">
        En général, on n'appelle pas directement les appels systèmes mais on utilise des fonctions de la librairie C
        qui les appellent indirectement&nbsp;:
        <ul>
            <li><code>fopen</code>, <code>fclose</code>
            </li><li><code>fgetc</code>, <code>fgets</code>, <code>fscanf</code>, etc.
            </li><li><code>fputc</code>, <code>fprintf</code>, <code>fputs</code>, etc.
        </li></ul>
        Ces fonctions manipulent les fichiers par l'intermédiaire de pointeurs de fichiers (<em>file pointers</em>)
        de type <code>FILE*</code> (structure contenant un descripteur de fichier, et des informations supplémentaires)
    </div>
<div class="slide_footer"><div class="page_counter">14 / 14</div></div><a href="#slide_anchor16" class="prev_flat_link"></a><a href="#slide_anchor18" class="next_flat_link"></a></section>






</body></html>
